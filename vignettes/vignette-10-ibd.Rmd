---
title: "Sharing of IBD segments across space and time"
# output: rmarkdown::html_vignette
output:
  md_document:
    variant: gfm
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Sharing of IBD segments across space and time}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
env_present <- slendr:::is_slendr_env_present()

knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.width = 10,
  fig.height = 7,
  dpi = 80,
  # eval = Sys.which("slim") != "" && env_present && Sys.getenv("RUNNER_OS") != "macOS"
  eval = FALSE
)
```


```{r, collapse = TRUE, message = FALSE, echo=FALSE}
devtools::load_all()

library(dplyr)
library(ggplot2)

init_env()

seed <- 314159
set.seed(seed)
```


```{r, results = FALSE, echo=FALSE}
# simulated world map
map <- world(
  xrange = c(-13, 70), # min-max longitude
  yrange = c(18, 65),  # min-max latitude
  crs = "EPSG:3035"    # coordinate reference system (CRS) for West Eurasia
)

# couple of broad geographic regions
africa <- region(
  "Africa", map,
  polygon = list(c(-18, 20), c(38, 20), c(30, 33),
                 c(20, 33), c(10, 38), c(-6, 35))
)
europe <- region(
  "Europe", map,
  polygon = list(
    c(-8, 35), c(-5, 36), c(10, 38), c(20, 35), c(25, 35),
    c(33, 45), c(20, 58), c(-5, 60), c(-15, 50)
  )
)
anatolia <- region(
  "Anatolia", map,
  polygon = list(c(28, 35), c(40, 35), c(42, 40),
                 c(30, 43), c(27, 40), c(25, 38))
)

# define population histories

# African ancestral population
afr <- population(
  "AFR", time = 60000, N = 10000,
  map = map, polygon = africa
)

# population of the first migrants out of Africa
ooa <- population(
  "OOA", parent = afr, time = 50000, N = 500, remove = 25000,
  center = c(33, 30), radius = 400e3
) %>%
  move(
    trajectory = list(c(40, 30), c(50, 30), c(60, 40)),
    start = 50000, end = 40000, snapshots = 20
  )

# Eastern hunter-gatherers
ehg <- population(
  "EHG", parent = ooa, time = 28000, N = 5000, remove = 6000,
  polygon = list(
    c(26, 55), c(38, 53), c(48, 53), c(60, 53),
    c(60, 60), c(48, 63), c(38, 63), c(26, 60))
)

# European population
eur <- population(name = "EUR", parent = ehg, time = 25000, N = 5000, polygon = europe) %>%
  resize(N = 20000, how = "exponential", time = 5000, end = 0)

# Anatolian farmers
ana <- population(
  name = "ANA", time = 28000, N = 10000, parent = ooa, remove = 4000,
  center = c(34, 38), radius = 500e3, polygon = anatolia
) %>%
  expand_range(
    by = 2500e3, start = 10000, end = 7000,
    polygon = join(europe, anatolia), snapshots = 20
  )

# Yamnaya steppe population
yam <- population(
  name = "YAM", time = 7000, N = 3000, parent = ehg, remove = 2500,
  polygon = list(c(26, 50), c(38, 49), c(48, 50),
                 c(48, 56), c(38, 59), c(26, 56))
) %>%
  move(trajectory = list(c(15, 50)), start = 5000, end = 3000, snapshots = 10)

# geneflow events
gf <- list(
  gene_flow(from = ana, to = yam, rate = 0.5, start = 6000, end = 5000, overlap = FALSE),
  gene_flow(from = ana, to = eur, rate = 0.5, start = 8000, end = 6000),
  gene_flow(from = yam, to = eur, rate = 0.75, start = 4000, end = 3000)
)

# compile the spatial model
model <- compile_model(
  populations = list(afr, ooa, ehg, eur, ana, yam),
  gene_flow = gf,
  generation_time = 30, resolution = 10e3,
  competition = 150e3, mating = 120e3, dispersal = 90e3
)
```


```{r}
plot_model(model)
```



```{r}
plot_map(model, gene_flow = TRUE)
```


```{r, echo=FALSE}
# one ancient individual every two thousand years
ancient <- schedule_sampling(
  model,
  times = seq(40000, 1, by = -500),
  list(ooa, 5), list(ehg, 5), list(eur, 5),
  list(ana, 5), list(yam, 5)
)

# present-day Africans and Europeans
present <- schedule_sampling(model, times = 0, list(afr, 100), list(eur, 100))

samples <- rbind(ancient, present)
```

Finally, we can simulate data from our model and process the output tree sequence (recapitate and simplify it):
```{r, eval=FALSE, echo=FALSE}
a = Sys.time()
ts_ <- slim(
  model, sequence_length = 100e6, recombination_rate = 1e-8,
  samples = samples, method = "batch", random_seed = 314159, max_attempts = 1
)
b = Sys.time()
b - a

ts <- ts_ %>%
  ts_recapitate(recombination_rate = 1e-8, Ne = 10000, random_seed = 314159) %>%
  ts_simplify()

ts_save(ts, "~/Desktop/ts.trees")
```

```{r}
ts <- ts_load("~/Desktop/ts.trees", model = model)
```

## Locations of sampled individuals (ancient and "present-day")

```{r}
# ibd %>%
# ggplot() +
#   geom_point(aes(abs(node1_time - node2_time), length)) +
#   labs(x = "time difference between two individuals", y = "IBD segment length")
```

```{r}
ggplot() +
  geom_sf(data = map) +
  geom_sf(data = ts_nodes(ts) %>% filter(sampled), aes(color = time))
```

```{r}
ggplot() +
  geom_sf(data = map) +
  geom_sf(data = ts_nodes(ts) %>% filter(sampled), aes(color = pop))
```

## Segments of IBD sharing

![](https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Pedigree%2C_recombination_and_resulting_IBD_segments%2C_schematic_representation_modified.png/2880px-Pedigree%2C_recombination_and_resulting_IBD_segments%2C_schematic_representation_modified.png)

```{r}
plot_map(model, gene_flow = TRUE)
```

```{r, echo=FALSE}
time_breaks <- c(Inf, 50, 40, 30, 25, 20, 10, 8, 6, 4, 2, 0) * 1e3
```

```{r, eval=FALSE}
ibd <- ts_ibd(ts, coordinates = TRUE, minimum_length = 1e6)
saveRDS(ibd, "~/Desktop/ibd.rds")
```

```{r, echo=FALSE}
ibd <- readRDS("~/Desktop/ibd.rds")
```


# IBD sharing as a mobility metric

```{r, fig.width=12, fig.height=7}
ibd %>%
  filter(name1 != name2, abs(node1_time - node2_time) < 3000) %>%
  mutate(
    distance = sf::st_length(connection) %>% units::set_units(km) %>% as.numeric(),
    pair = paste(pop1, " - ", pop2),
    avg_age = purrr::map2_dbl(node1_time, node2_time, ~ mean(c(.x, .y)))
  ) %>%
  ggplot() +
    geom_point(aes(avg_age, distance, color = pair)) +
    labs(x = "time [years ago]",
         y = "distance separating an IBD pair [km]") +
    coord_cartesian(ylim = c(0, 5000), xlim = c(0, 40000))
```

```{r, fig.width=12, fig.height=7}
ibd %>%
  filter(pop1 == pop2) %>%
  mutate(
    distance = sf::st_length(connection) %>% units::set_units(km) %>% as.numeric(),
    pair = paste(pop1, " - ", pop2),
    avg_age = purrr::map2_dbl(node1_time, node2_time, ~ mean(c(.x, .y)))
  ) %>%
  ggplot(aes(avg_age, distance, color = pair)) +
    geom_point() +
    geom_smooth(aes(group = 1), color = "black") +
    labs(x = "time [years ago]",
         y = "distance separating an IBD pair [km]") +
    coord_cartesian(ylim = c(0, 5000), xlim = c(0, 40000)) +
    facet_wrap(~ pair)
```



# Sharing of IBD segments across space and time

```{r, fig.width=12, fig.height=7}
time_breaks <- c(Inf, 50, 40, 30, 25, 20, 10, 8, 6, 4, 2, 0) * 1e3

ibd %>%
  filter(pop1 == "EHG") %>%
  mutate(
    distance = sf::st_length(connection) %>% units::set_units(km) %>% as.numeric(),
    pair = paste(pop1, " - ", pop2),
    epoch = cut(node1_time, breaks = time_breaks, dig.lab = 10, include.lowest = TRUE)
  ) %>% {
    ggplot() +
      geom_sf(data = map) +
      geom_sf(data = ., aes(color = pair), alpha = 0.75) +
      facet_wrap(~ epoch, drop = FALSE) +
      ggtitle("Long-range spatial IBD sharing with EHG")
  }
```


```{r, fig.width=12, fig.height=7}
time_breaks <- c(Inf, 50, 40, 30, 25, 20, 10, 8, 6, 4, 2, 0) * 1e3

ibd %>%
  filter(pop2 == "EUR") %>%
  mutate(
    distance = sf::st_length(connection) %>% units::set_units(km) %>% as.numeric(),
    pair = paste(pop2, " - ", pop1),
    epoch = cut(node1_time, breaks = time_breaks, dig.lab = 10, include.lowest = TRUE)
  ) %>% {
    ggplot() +
      geom_sf(data = map) +
      geom_sf(data = ., aes(color = pair), alpha = 0.75) +
      facet_wrap(~ epoch, drop = FALSE) +
      ggtitle("Long-range spatial IBD sharing with EUR")
  }
```

```{r, fig.width=12, fig.height=7}
time_breaks <- c(Inf, 50, 40, 30, 25, 20, 10, 8, 6, 4, 2, 0) * 1e3

ibd %>%
  filter(pop1 == "ANA") %>%
  mutate(
    distance = sf::st_length(connection) %>% units::set_units(km) %>% as.numeric(),
    pair = paste(pop1, " - ", pop2),
    epoch = cut(node1_time, breaks = time_breaks, dig.lab = 10, include.lowest = TRUE)
  ) %>% {
    ggplot() +
      geom_sf(data = map) +
      geom_sf(data = ., aes(color = pair), alpha = 0.75) +
      facet_wrap(~ epoch, drop = FALSE) +
      ggtitle("Long-range spatial IBD sharing with ANA")
  }
```
